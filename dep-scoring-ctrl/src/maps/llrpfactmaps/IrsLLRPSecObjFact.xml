<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">
<sqlMap namespace="IrsLLRPSecObjFact">

<select id="LLRPfindBySecObjStudentSession" parameterClass="com.ctb.lexington.db.irsdata.irsllrpdata.IrsLLRPSecObjFactData" resultClass="com.ctb.lexington.db.irsdata.irsllrpdata.IrsLLRPSecObjFactData">
SELECT 
        FACTID as factid,
        SEC_OBJID as secObjid,
        STUDENTID as studentid,        
        FORMID as formid,
        SESSIONID as sessionid,
        ATTR2ID as attr2id,
        ATTR9ID as attr9id,
        ATTR11ID as attr11id,
        ATTR12ID as attr12id,
        ATTR13ID as attr13id,
        ATTR14ID as attr14id,
        ATTR15ID as attr15id,
        ATTR16ID as attr16id,
        ATTR17ID as attr17id,
        ATTR18ID as attr18id,
        ATTR19ID as attr19id,
        ATTR20ID as attr20id,
        ATTR21ID as attr21id,
        ATTR22ID as attr22id,
        ATTR23ID as attr23id,
        ATTR25ID as attr25id,
        ATTR26ID as attr26id,
        ATTR27ID as attr27id,
        ATTR28ID as attr28id,
        ATTR29ID as attr29id,
        ATTR30ID as attr30id,
        ATTR31ID as attr31id,
        ATTR32ID as attr32id,
        ATTR33ID as attr33id,
        ATTR34ID as attr34id,
        ATTR35ID as attr35id,
        ATTR36ID as attr36id,
        ATTR37ID as attr37id,
        GRADEID	as gradeid,
        LEVELID	as levelid,
        ORG_NODEID	as orgNodeid,
        ASSESSMENTID as assessmentid,
        PROGRAMID as programid,	
        CURRENT_RESULTID as currentResultid,
        MASTERY_LEVELID as masteryLevelid,
        POINTS_ATTEMPTED as pointsAttempted,
        PERCENT_OBTAINED as percentObtained,
        POINTS_OBTAINED as pointsObtained,
        TEST_COMPLETION_TIMESTAMP as testCompletionTimestamp,
        TEST_START_TIMESTAMP as testStartTimestamp,
        POINTS_POSSIBLE as pointsPossible
FROM
        LASLINK_SEC_OBJ_FACT  
WHERE 
			STUDENTID = #studentid:NUMERIC#
		AND
			SESSIONID =  #sessionid:NUMERIC#
		AND		
	        SEC_OBJID = #secObjid:NUMERIC#
</select> 

<insert id="LLRPinsertLLSecObjFact" parameterClass="com.ctb.lexington.db.irsdata.irsllrpdata.IrsLLRPSecObjFactData">

        INSERT INTO
            LASLINK_SEC_OBJ_FACT
                (
                FACTID,
		        SEC_OBJID,
        		STUDENTID,        
		        FORMID,
		        SESSIONID,
		        ATTR2ID,
		        ATTR9ID,
		        ATTR11ID,
		        ATTR12ID,
    		    ATTR13ID,
		        ATTR14ID,
		        ATTR15ID,
		        ATTR16ID,
		        ATTR17ID,
		        ATTR18ID,
		        ATTR19ID,
		        ATTR20ID,
		        ATTR21ID,
		        ATTR22ID,
		        ATTR23ID,
		        ATTR25ID,
		        ATTR26ID,
		        ATTR27ID,
		        ATTR28ID,
		        ATTR29ID,
		        ATTR30ID,
		        ATTR31ID,
		        ATTR32ID,
		        ATTR33ID,
		        ATTR34ID,
		        ATTR35ID,
		        ATTR36ID,
		        ATTR37ID,
		        GRADEID,
		        LEVELID,
		        ORG_NODEID,
		        ASSESSMENTID,
		        PROGRAMID,	
		        CURRENT_RESULTID,
        		MASTERY_LEVELID,
		        POINTS_ATTEMPTED,
		        PERCENT_OBTAINED,
		        POINTS_OBTAINED,
        		TEST_COMPLETION_TIMESTAMP,
        		TEST_START_TIMESTAMP,
		        POINTS_POSSIBLE
                )
        VALUES
                (
                #factid:NUMERIC#,
                #secObjid:NUMERIC#,
                #studentid:NUMERIC#,
                #formid:NUMERIC#,
                #sessionid:NUMERIC#,
                #attr2id:NUMERIC#,
                #attr9id:NUMERIC#,
                #attr11id:NUMERIC#,
		        #attr12id:NUMERIC#,
		        #attr13id:NUMERIC#,
		        #attr14id:NUMERIC#,
		        #attr15id:NUMERIC#,
		        #attr16id:NUMERIC#,
		        #attr17id:NUMERIC#,
		        #attr18id:NUMERIC#,
		        #attr19id:NUMERIC#,
		        #attr20id:VARCHAR#,
		        #attr21id:VARCHAR#,
		        #attr22id:NUMERIC#,
		        #attr23id:VARCHAR#,
		        #attr25id:NUMERIC#,
		        #attr26id:NUMERIC#,
		        #attr27id:NUMERIC#,
		        #attr28id:NUMERIC#,
		        #attr29id:NUMERIC#,
		        #attr30id:NUMERIC#,
		        #attr31id:NUMERIC#,
		        #attr32id:NUMERIC#,
		        #attr33id:NUMERIC#,
		        #attr34id:NUMERIC#,
		        #attr35id:NUMERIC#,
		        #attr36id:NUMERIC#,
		        #attr37id:NUMERIC#,
                #gradeid:NUMERIC#,
                #levelid:NUMERIC#,
                #orgNodeid:NUMERIC#,
                #assessmentid:NUMERIC#,
                #programid:NUMERIC#,
                decode(#currentResultid:NUMERIC#, 1,
                decode(
                    sign( 
                        NVL(to_number(
                            TO_CHAR(
                                to_timestamp(
                                    to_char((select max(test_completion_timestamp) from laslink_sec_obj_fact fact, 
                                        sec_obj_dim secdim, prim_obj_dim primdim, content_area_dim condim
                                        where fact.sessionid != #sessionid:NUMERIC#
                                        and fact.studentid = #studentid:NUMERIC#
                                        and fact.assessmentid = #assessmentid:NUMERIC#
                                        and programid = #programid:NUMERIC#
                                        and fact.current_Resultid = 1
                                        and fact.sec_objid = secdim.sec_objid
                                        and secdim.prim_objid = primdim.prim_objid
                                        and primdim.content_Areaid = condim.content_areaid
                                        and #subtestName:VARCHAR# like '%' || condim.name
                                    ), 'MM/DD/YYYY HH24:MI:SS'), 'MM/DD/YYYY HH24:MI:SS'
                                ), 
                                'YYYYMMDDHH24MISSFF3'
                            )
                        ), 0) -
                        to_number(
                            TO_CHAR(
                                to_timestamp(
                                    #testCompletionTimestamp:TIMESTAMP#
                                ), 
                                'YYYYMMDDHH24MISSFF3'
                            )
                        )
                    ), 
                    -1, 
                    1,
                    0,
                    2,
                    1,
                    2,
                    1
                ), 2), 
                #masteryLevelid:NUMERIC#,
                #pointsAttempted:NUMERIC#,
                #percentObtained:NUMERIC#,
                #pointsObtained:NUMERIC#,
                #testCompletionTimestamp:TIMESTAMP#,
                #testStartTimestamp:TIMESTAMP#,
                #pointsPossible:NUMERIC#
                )        
</insert>
<update id="LLRPupdateLLSecObjFact" parameterClass="com.ctb.lexington.db.irsdata.irsllrpdata.IrsLLRPSecObjFactData">
       
        UPDATE
                LASLINK_SEC_OBJ_FACT
        SET
				FACTID = #factid:NUMERIC#,	
	    	    FORMID = #formid:NUMERIC#,		
		        ATTR2ID = #attr2id:NUMERIC#,		
		        ATTR9ID	= #attr9id:NUMERIC#,	
		        ATTR11ID = #attr11id:NUMERIC#,
				ATTR12ID = #attr12id:NUMERIC#,
				ATTR13ID = #attr13id:NUMERIC#,
			    ATTR14ID = #attr14id:NUMERIC#,
				ATTR15ID = #attr15id:NUMERIC#,
				ATTR16ID = #attr16id:NUMERIC#,
				ATTR17ID = #attr17id:NUMERIC#,
				ATTR18ID = #attr18id:NUMERIC#,
				ATTR19ID = #attr19id:NUMERIC#,
				ATTR20ID = #attr20id:VARCHAR#,
				ATTR21ID = #attr21id:VARCHAR#,
				ATTR22ID = #attr22id:NUMERIC#,
				ATTR23ID = #attr23id:VARCHAR#,
				ATTR25ID = #attr25id:NUMERIC#,
				ATTR26ID = #attr26id:NUMERIC#,
				ATTR27ID = #attr27id:NUMERIC#,
				ATTR28ID = #attr28id:NUMERIC#,
				ATTR29ID = #attr29id:NUMERIC#,
				ATTR30ID = #attr30id:NUMERIC#,
				ATTR31ID = #attr31id:NUMERIC#,
				ATTR32ID = #attr32id:NUMERIC#,
				ATTR33ID = #attr33id:NUMERIC#,
				ATTR34ID = #attr34id:NUMERIC#,
				ATTR35ID = #attr35id:NUMERIC#,
				ATTR36ID = #attr36id:NUMERIC#,
				ATTR37ID = #attr37id:NUMERIC#,	
		        GRADEID = #gradeid:NUMERIC#,	
		        LEVELID = #levelid:NUMERIC#,	
		        ORG_NODEID = #orgNodeid:NUMERIC#,	
		        ASSESSMENTID = #assessmentid:NUMERIC#,	
		        PROGRAMID = #programid:NUMERIC#,	
		        CURRENT_RESULTID = #currentResultid:NUMERIC#,	
				MASTERY_LEVELID = #masteryLevelid:NUMERIC#,	
		        POINTS_ATTEMPTED = #pointsAttempted:NUMERIC#,	
		        PERCENT_OBTAINED = #percentObtained:NUMERIC#,	
		        POINTS_OBTAINED = #pointsObtained:NUMERIC#,	
				TEST_COMPLETION_TIMESTAMP = #testCompletionTimestamp:TIMESTAMP#,
				TEST_START_TIMESTAMP = #testStartTimestamp:TIMESTAMP#,	
		        POINTS_POSSIBLE = #pointsPossible:NUMERIC#	
        WHERE 
			STUDENTID = #studentid:NUMERIC#
		AND
			SESSIONID =  #sessionid:NUMERIC#
		AND		
	        SEC_OBJID = #secObjid:NUMERIC#
</update>
<update id="LLRPupdateLLSecObjFactCurrentResult" parameterClass="com.ctb.lexington.db.irsdata.irsllrpdata.IrsLLRPSecObjFactData">
       
        UPDATE
                LASLINK_SEC_OBJ_FACT fact
        SET	
		        CURRENT_RESULTID = #currentResultid:NUMERIC#	
        WHERE 
			STUDENTID = #studentid:NUMERIC#
        AND
            SESSIONID != #sessionid:NUMERIC#
        AND
			(sec_objID in (select currsecdim.sec_objID 
                                from LASLINK_sec_obj_FACT secfact, 
                                sec_obj_dim secdim, prim_obj_dim primdim, content_Area_dim condim,
                                prim_obj_dim currprimdim, sec_obj_dim currsecdim
                                where secfact.sessionid = #sessionid:NUMERIC#
                                and secfact.studentid = #studentid:NUMERIC#
                                and secdim.sec_objid = secfact.sec_objid
                                and primdim.prim_objid = secdim.prim_objid
                                and condim.content_Areaid = primdim.content_areaid
                                and currprimdim.content_areaid = condim.content_areaid
                                and currsecdim.prim_objid = currprimdim.prim_objid
                        )
            OR #currentResultid:NUMERIC# = 1)
        AND
            test_completion_timestamp = (select max(test_completion_timestamp) from laslink_sec_obj_fact
                        where sessionid != #sessionid:NUMERIC#
                        and studentid = #studentid:NUMERIC#
                        and assessmentid = fact.assessmentid
                        and test_completion_timestamp &lt;= decode(#currentResultid:NUMERIC#, 1, sysdate, #testCompletionTimestamp:TIMESTAMP#))        
</update>

<delete id="LLRPdeleteBySecObjFactId" parameterClass="com.ctb.lexington.db.irsdata.irsllrpdata.IrsLLRPSecObjFactData">

	DELETE FROM
			LASLINK_SEC_OBJ_FACT
	WHERE 
			STUDENTID = #studentid:NUMERIC#
		AND
			SESSIONID =  #sessionid:NUMERIC#
		AND		
	        SEC_OBJID = #secObjid:NUMERIC#
</delete>
</sqlMap>