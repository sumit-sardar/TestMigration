<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">
<sqlMap namespace="IrsTRItemFact">

	<select id="TRfindByItemStudentSession"
		parameterClass="com.ctb.lexington.db.irsdata.irstrdata.IrsTRItemFactData"
		resultClass="com.ctb.lexington.db.irsdata.irstrdata.IrsTRItemFactData">
		SELECT 
        FACTID as factid,
        STUDENTID as studentid,        
        FORMID as formid,
        SESSIONID as sessionid,
        GRADEID	as gradeid,
        LEVELID	as levelid,
        ITEMID as itemid,
        ORG_NODEID	as orgNodeid,
        ASSESSMENTID as assessmentid,
        PROGRAMID as programid,	
        CURRENT_RESULTID as currentResultid,
        POINTS_OBTAINED as pointsObtained,
        ITEM_RESPONSE_TIMESTAMP	as itemResponseTimestamp,
        TEST_COMPLETION_TIMESTAMP as testCompletionTimestamp,
        RESPONSEID as responseid,
        POINTS_POSSIBLE as pointsPossible
FROM
        TASC_ITEM_FACT  
WHERE 
			STUDENTID = #studentid:NUMERIC#
		AND
			SESSIONID =  #sessionid:NUMERIC#
		AND		
	        ITEMID = #itemid:NUMERIC#
	</select>

	<insert id="TRinsertItemFact"
		parameterClass="com.ctb.lexington.db.irsdata.irstrdata.IrsTRItemFactData">

		INSERT INTO
            TASC_ITEM_FACT
                (
                FACTID,
        		STUDENTID,        
		        FORMID,
        		SESSIONID,
        		GRADEID,
		        LEVELID,
		        ITEMID,
        		ORG_NODEID,
		        ASSESSMENTID,
		        PROGRAMID,	
        		CURRENT_RESULTID,
		        POINTS_OBTAINED,
		        ITEM_RESPONSE_TIMESTAMP,
        		TEST_COMPLETION_TIMESTAMP,
		        RESPONSEID,
        		POINTS_POSSIBLE
                )
        VALUES
                (
                #factid:NUMERIC#,
                #studentid:NUMERIC#,
                #formid:NUMERIC#,
                #sessionid:NUMERIC#,
                #gradeid:NUMERIC#,
                #levelid:NUMERIC#,
                #itemid:NUMERIC#,
                #orgNodeid:NUMERIC#,
                #assessmentid:NUMERIC#,
                #programid:NUMERIC#,
                decode(
                    sign( 
                        NVL(to_number(
                            TO_CHAR(
                                to_timestamp(
                                    to_char((select max(test_completion_timestamp) from tasc_item_fact fact,
                                        item_dim itemdim, sec_obj_dim secdim, prim_obj_dim primdim, content_area_dim condim
                                        where fact.sessionid != #sessionid:NUMERIC#
                                        and fact.studentid = #studentid:NUMERIC#
                                        and fact.assessmentid = #assessmentid:NUMERIC#
                                        and fact.current_Resultid = 1
                                        and fact.itemid = itemdim.itemid
                                        and itemdim.sec_objid = secdim.sec_objid
                                        and secdim.prim_objid = primdim.prim_objid
                                        and primdim.content_Areaid = condim.content_areaid
                                        and (#subtestName:VARCHAR# = 'TABE ' || condim.name OR (#subtestName:VARCHAR# = 'TABE Mathematics Computation' and condim.name = 'Math Computation'))  
                                    ), 'MM/DD/YYYY HH24:MI:SS'), 'MM/DD/YYYY HH24:MI:SS'
                                ), 
                                'YYYYMMDDHH24MISSFF3'
                            )
                        ), 0) -
                        to_number(
                            TO_CHAR(
                                to_timestamp(
                                    #testCompletionTimestamp:TIMESTAMP#
                                ), 
                                'YYYYMMDDHH24MISSFF3'
                            )
                        )
                    ), 
                    -1, 
                    1,
                    0,
                    2,
                    1,
                    2,
                    1
                ),
                #pointsObtained:NUMERIC#,
                #itemResponseTimestamp:TIMESTAMP#,
                #testCompletionTimestamp:TIMESTAMP#,
                #responseid:NUMERIC#,
                #pointsPossible:NUMERIC#
                ) 
	</insert>

	<update id="TRupdateItemFact"
		parameterClass="com.ctb.lexington.db.irsdata.irstrdata.IrsTRItemFactData">

		UPDATE
                TASC_ITEM_FACT
        SET
        	FACTID = #factid:NUMERIC#,
        	FORMID = #formid:NUMERIC#,
			GRADEID = #gradeid:NUMERIC#,
			LEVELID	= #levelid:NUMERIC#,
			ORG_NODEID = #orgNodeid:NUMERIC#,
			ASSESSMENTID = #assessmentid:NUMERIC#,
			PROGRAMID = #programid:NUMERIC#,
			CURRENT_RESULTID = #currentResultid:NUMERIC#,
			POINTS_OBTAINED = #pointsObtained:NUMERIC#,
			ITEM_RESPONSE_TIMESTAMP = #itemResponseTimestamp:TIMESTAMP#,
			TEST_COMPLETION_TIMESTAMP = #testCompletionTimestamp:TIMESTAMP#,
			RESPONSEID = #responseid:NUMERIC#,
			POINTS_POSSIBLE = #pointsPossible:NUMERIC#
        WHERE 
			STUDENTID = #studentid:NUMERIC#
		AND
			SESSIONID =  #sessionid:NUMERIC#
		AND		        
	        ITEMID = #itemid:NUMERIC#
	</update>

	<update id="TRupdateItemFactCurrentResult"
		parameterClass="com.ctb.lexington.db.irsdata.irstrdata.IrsTRItemFactData">

		UPDATE
                TASC_ITEM_FACT fact
        SET	
		        CURRENT_RESULTID = #currentResultid:NUMERIC#	
        WHERE 
			STUDENTID = #studentid:NUMERIC#
        AND
            SESSIONID != #sessionid:NUMERIC#
        AND
			(itemID in (select curritemdim.itemID 
                                from TASC_item_FACT itemfact, 
                                item_dim itemdim, sec_obj_dim secdim, prim_obj_dim primdim, content_Area_dim condim,
                                prim_obj_dim currprimdim, sec_obj_dim currsecdim, item_dim curritemdim
                                where itemfact.sessionid = #sessionid:NUMERIC#
                                and itemfact.studentid = #studentid:NUMERIC#
                                and itemdim.itemid = itemfact.itemid
                                and secdim.sec_objid = itemdim.sec_objid
                                and primdim.prim_objid = secdim.prim_objid
                                and condim.content_Areaid = primdim.content_areaid
                                and currprimdim.content_areaid = condim.content_areaid
                                and currsecdim.prim_objid = currprimdim.prim_objid
                                and curritemdim.sec_objid = currsecdim.sec_objid
                        )
            OR #currentResultid:NUMERIC# = 1)
        AND
            test_completion_timestamp = (select max(test_completion_timestamp) from tasc_item_fact
                        where sessionid != #sessionid:NUMERIC#
                        and studentid = #studentid:NUMERIC#
                        and itemid = fact.itemid
                        and assessmentid = fact.assessmentid
                        and test_completion_timestamp &lt;= decode(#currentResultid:NUMERIC#, 1, sysdate, #testCompletionTimestamp:TIMESTAMP#))
	</update>

	<delete id="TRdeleteByItemFactId"
		parameterClass="com.ctb.lexington.db.irsdata.irstrdata.IrsTRItemFactData">

		DELETE FROM
			TASC_ITEM_FACT
	WHERE 
			STUDENTID = #studentid:NUMERIC#
		AND
			SESSIONID =  #sessionid:NUMERIC#
		AND		
	        ITEMID = #itemid:NUMERIC#
	</delete>
	
	<update id="TRmergeFieldTestItemFact"
		parameterClass="com.ctb.lexington.db.irsdata.irstrdata.IrsTRItemFactData">

		MERGE INTO TASC_ITEM_FACT FTFACT
		USING DUAL
		ON (FTFACT.ITEMID = #itemid:NUMERIC# AND FTFACT.STUDENTID = #studentid:NUMERIC# AND FTFACT.SESSIONID = #sessionid:NUMERIC#)
		WHEN MATCHED THEN
		  UPDATE
		     SET FTFACT.POINTS_OBTAINED = #pointsObtained:NUMERIC#,
		         FTFACT.POINTS_POSSIBLE = #pointsPossible:NUMERIC#,
		         FTFACT.ITEM_RESPONSE_TIMESTAMP = #itemResponseTimestamp:TIMESTAMP#,
		         FTFACT.TEST_COMPLETION_TIMESTAMP = #testCompletionTimestamp:TIMESTAMP#,
		         FTFACT.RESPONSEID = #responseid:NUMERIC#
		WHEN NOT MATCHED THEN
		  INSERT
		    (FACTID,
		     STUDENTID,
		     FORMID,
		     SESSIONID,
		     GRADEID,
		     LEVELID,
		     ITEMID,
		     ORG_NODEID,
		     ASSESSMENTID,
		     PROGRAMID,
		     CURRENT_RESULTID,
		     POINTS_OBTAINED,
		     ITEM_RESPONSE_TIMESTAMP,
		     TEST_COMPLETION_TIMESTAMP,
		     RESPONSEID,
		     POINTS_POSSIBLE,
		     FIELD_TEST)
		  VALUES
		    (#factid:NUMERIC#,
		     #studentid:NUMERIC#,
		     #formid:NUMERIC#,
		     #sessionid:NUMERIC#,
		     #gradeid:NUMERIC#,
		     #levelid:NUMERIC#,
		     #itemid:NUMERIC#,
		     #orgNodeid:NUMERIC#,
		     #assessmentid:NUMERIC#,
		     #programid:NUMERIC#,
             decode(
                 sign( 
                     NVL(to_number(
                         TO_CHAR(
                             to_timestamp(
                                 to_char((select max(test_completion_timestamp) from tasc_item_fact fact,
                                     item_dim itemdim, sec_obj_dim secdim, prim_obj_dim primdim, content_area_dim condim
                                     where fact.sessionid != #sessionid:NUMERIC#
                                     and fact.studentid = #studentid:NUMERIC#
                                     and fact.assessmentid = #assessmentid:NUMERIC#
                                     and fact.current_Resultid = 1
                                     and fact.itemid = itemdim.itemid
                                     and itemdim.sec_objid = secdim.sec_objid
                                     and secdim.prim_objid = primdim.prim_objid
                                     and primdim.content_Areaid = condim.content_areaid
                                     and (#subtestName:VARCHAR# = 'TABE ' || condim.name OR (#subtestName:VARCHAR# = 'TABE Mathematics Computation' and condim.name = 'Math Computation'))  
                                 ), 'MM/DD/YYYY HH24:MI:SS'), 'MM/DD/YYYY HH24:MI:SS'
                             ), 
                             'YYYYMMDDHH24MISSFF3'
                         )
                     ), 0) -
                     to_number(
                         TO_CHAR(
                             to_timestamp(
                                 #testCompletionTimestamp:TIMESTAMP#
                             ), 
                             'YYYYMMDDHH24MISSFF3'
                         )
                     )
                 ), 
                 -1, 
                 1,
                 0,
                 2,
                 1,
                 2,
                 1
             ),
             #pointsObtained:NUMERIC#,
             #itemResponseTimestamp:TIMESTAMP#,
             #testCompletionTimestamp:TIMESTAMP#,
             #responseid:NUMERIC#,
             #pointsPossible:NUMERIC#,
             'T'
             ) 
	</update>
</sqlMap>