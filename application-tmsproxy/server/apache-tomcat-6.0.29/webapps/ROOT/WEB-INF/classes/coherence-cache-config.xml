<?xml version="1.0"?>
<!DOCTYPE cache-config SYSTEM "cache-config.dtd">

<cache-config
	xmlns:sync="class:com.oracle.coherence.patterns.pushreplication.configuration.PushReplicationNamespaceContentHandler"
    xmlns:cr="class:com.oracle.coherence.environment.extensible.namespaces.InstanceNamespaceContentHandler">

	<introduce:config file="coherence-messagingpattern-cache-config.xml" />

    <sync:provider pof-enabled="false">
        <sync:coherence-provider />
    </sync:provider>
	
    <caching-scheme-mapping>
        <cache-mapping>
	        <cache-name>ADS*</cache-name>
	        <scheme-name>TieredScheme</scheme-name>
        </cache-mapping>
        <!--    Caches with any name will be created as tiered.    -->
        <cache-mapping>
	        <cache-name>OASResponse*</cache-name>
	        <scheme-name>DistributedScheme</scheme-name>
	        <sync:publisher>
                <sync:publisher-name>Active Publisher</sync:publisher-name>
                <sync:publisher-scheme>
                    <sync:remote-cluster-publisher-scheme>
                        <sync:remote-invocation-service-name>remote-site</sync:remote-invocation-service-name>
                        <sync:remote-publisher-scheme>
                            <sync:local-cache-publisher-scheme>
                                <sync:target-cache-name>{cache-name}</sync:target-cache-name>
                                <sync:conflict-resolver-scheme>
                                        <cr:class classname="com.ctb.tms.nosql.coherence.push.TMSConflictResolver" />
                                </sync:conflict-resolver-scheme>
                            </sync:local-cache-publisher-scheme>
                        </sync:remote-publisher-scheme>
                        <sync:autostart>true</sync:autostart>
                        <sync:publish-original-value>true</sync:publish-original-value>
                    </sync:remote-cluster-publisher-scheme>
                </sync:publisher-scheme>
            </sync:publisher>
        </cache-mapping>
        <cache-mapping>
	        <cache-name>OASManifest*</cache-name>
	        <scheme-name>TieredScheme</scheme-name>
	        <sync:publisher>
                <sync:publisher-name>Active Publisher</sync:publisher-name>
                <sync:publisher-scheme>
                    <sync:remote-cluster-publisher-scheme>
                        <sync:remote-invocation-service-name>remote-site</sync:remote-invocation-service-name>
                        <sync:remote-publisher-scheme>
                            <sync:local-cache-publisher-scheme>
                                <sync:target-cache-name>{cache-name}</sync:target-cache-name>
                                <sync:conflict-resolver-scheme>
                                        <cr:class classname="com.ctb.tms.nosql.coherence.push.TMSConflictResolver" />
                                </sync:conflict-resolver-scheme>
                            </sync:local-cache-publisher-scheme>
                        </sync:remote-publisher-scheme>
                        <sync:autostart>true</sync:autostart>
                        <sync:publish-original-value>true</sync:publish-original-value>
                    </sync:remote-cluster-publisher-scheme>
                </sync:publisher-scheme>
            </sync:publisher>
        </cache-mapping>
        <cache-mapping>
	        <cache-name>OASRoster*</cache-name>
	        <scheme-name>TieredScheme</scheme-name>
	        <sync:publisher>
                <sync:publisher-name>Active Publisher</sync:publisher-name>
                <sync:publisher-scheme>
                    <sync:remote-cluster-publisher-scheme>
                        <sync:remote-invocation-service-name>remote-site</sync:remote-invocation-service-name>
                        <sync:remote-publisher-scheme>
                            <sync:local-cache-publisher-scheme>
                                <sync:target-cache-name>{cache-name}</sync:target-cache-name>
                                <sync:conflict-resolver-scheme>
                                        <cr:class classname="com.ctb.tms.nosql.coherence.push.TMSConflictResolver" />
                                </sync:conflict-resolver-scheme>
                            </sync:local-cache-publisher-scheme>
                        </sync:remote-publisher-scheme>
                        <sync:autostart>true</sync:autostart>
                        <sync:publish-original-value>true</sync:publish-original-value>
                    </sync:remote-cluster-publisher-scheme>
                </sync:publisher-scheme>
            </sync:publisher>
        </cache-mapping>
    </caching-scheme-mapping>
    <caching-schemes>  
    	<!--        heap-limited memory scheme definition -->
    	<local-scheme>
   			<scheme-name>BackMemoryScheme</scheme-name>
   			<high-units>536870912</high-units>
   			<unit-calculator>BINARY</unit-calculator>
		</local-scheme>
		<local-scheme>
   			<scheme-name>FrontMemoryScheme</scheme-name>
   			<high-units>250000</high-units>
   			<unit-calculator>FIXED</unit-calculator>
		</local-scheme>   
        <!--        Oracle backing store scheme definition -->
        <read-write-backing-map-scheme>
		  <scheme-name>DBScheme</scheme-name>
		  <internal-cache-scheme>
		    <local-scheme>
		      <scheme-ref>BackMemoryScheme</scheme-ref>
		    </local-scheme>
		  </internal-cache-scheme>
		  <cachestore-scheme>
		    <class-scheme>
		      <class-name>com.ctb.tms.nosql.coherence.DBCacheStore</class-name>
		      <init-params>
		        <init-param>
		          <param-type>java.lang.String</param-type>
		          <param-value>{cache-name}</param-value>
		        </init-param>
		      </init-params>
		    </class-scheme>
		  </cachestore-scheme>
		  <write-delay>1s</write-delay>
		</read-write-backing-map-scheme>
        <!--        Default Distributed caching scheme.        -->
        <distributed-scheme>            
            <scheme-name>DistributedScheme</scheme-name>
            <service-name>PartitionedCache</service-name> 
            <thread-count>4</thread-count>           
            <backing-map-scheme>                
                <read-write-backing-map-scheme>                    
                    <scheme-ref>DBScheme</scheme-ref>
                </read-write-backing-map-scheme>
            </backing-map-scheme>
            <partition-count>509</partition-count>
            <backup-count>1</backup-count>
            <autostart>true</autostart>
        </distributed-scheme>
        <!--        2-tier (memory, disk/db) scheme definition -->
        <near-scheme>
        	<scheme-name>TieredScheme</scheme-name>
        	<front-scheme>    
        		<local-scheme>
        			<scheme-ref>FrontMemoryScheme</scheme-ref>
        		</local-scheme>  
        	</front-scheme>  
        	<back-scheme>
				<distributed-scheme>
					<scheme-ref>DistributedScheme</scheme-ref>
				</distributed-scheme>
			</back-scheme>
		</near-scheme> 
		<!-- these are for push replication -->
		<proxy-scheme>
			<scheme-name>proxy-scheme</scheme-name>
			<service-name>ExtendTcpProxyService</service-name>
			<thread-count>4</thread-count>
            <acceptor-config>
                <tcp-acceptor>
	                <address-provider>
                    	<class-name>com.ctb.tms.nosql.coherence.push.TMSLocalAddressProvider</class-name>
                    </address-provider>
                </tcp-acceptor>
            </acceptor-config>    
            <proxy-config>
            	<cache-service-proxy>
            		<enabled>true</enabled>
            	</cache-service-proxy>
            	<invocation-service-proxy>
            		<enabled>true</enabled>
            	</invocation-service-proxy>
            </proxy-config>   
            <autostart>true</autostart>
        </proxy-scheme>
		<remote-invocation-scheme> 
			<service-name>remote-site</service-name> 
			<initiator-config> 
				<tcp-initiator> 
					<remote-addresses>
						<address-provider>
	                    	<class-name>com.ctb.tms.nosql.coherence.push.TMSRemoteAddressProvider</class-name>
	                    </address-provider>
	                </remote-addresses>
					<connect-timeout>2s</connect-timeout> 
				</tcp-initiator> 
				<outgoing-message-handler> 
					<request-timeout>5s</request-timeout> 
				</outgoing-message-handler> 
			</initiator-config> 
		</remote-invocation-scheme>  
    </caching-schemes>
</cache-config>